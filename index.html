<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alerta Arroyo Escobar</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --color-primario: #1e88e5;
      --color-secundario: #ff7043;
      --fondo-oscuro: #121212;
      --fondo-tarjeta: #1e1e1e;
      --texto-claro: #f5f5f5;
      --texto-secundario: #9e9e9e;
      --color-promedio: #4caf50;
      --color-cauce-alto: #64b5f6;
      --color-cauce-medio: #4db6ac;
      --color-cauce-bajo: #81c784;
      --color-temperatura: #ffa726;
    }
    
    body {
      margin: 0;
      padding: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--fondo-oscuro);
      color: var(--texto-claro);
      line-height: 1.4;
      font-size: 14px;
    }
    
    .contenedor {
      max-width: 390px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .encabezado {
      text-align: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }
    
    .encabezado h1 {
      color: var(--color-primario);
      margin-bottom: 4px;
      font-size: 18px;
    }
    
    .encabezado h2 {
      color: var(--color-secundario);
      margin-top: 0;
      font-size: 14px;
      font-weight: normal;
    }
    
    .selector-tiempo {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .selector-tiempo button {
      padding: 6px 10px;
      background-color: #333;
      color: var(--texto-claro);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }
    
    .selector-tiempo button.active {
      background-color: var(--color-primario);
      font-weight: bold;
    }
    
    .grid-cauces {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .tarjeta-cauce {
      background-color: var(--fondo-tarjeta);
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .cauce-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .cauce-titulo {
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .cauce-alto .cauce-titulo {
      color: var(--color-cauce-alto);
    }
    
    .cauce-medio .cauce-titulo {
      color: var(--color-cauce-medio);
    }
    
    .cauce-bajo .cauce-titulo {
      color: var(--color-cauce-bajo);
    }
    
    .cauce-titulo i {
      font-size: 14px;
    }
    
    .estado-activo {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .temperatura {
      font-size: 13px;
      color: var(--color-temperatura);
      display: flex;
      align-items: center;
      gap: 3px;
    }
    
    .temperatura i {
      font-size: 12px;
    }
    
    .latido {
      width: 8px;
      height: 8px;
      background-color: #4CAF50;
      border-radius: 50%;
      animation: latido 1.5s infinite;
      margin-left: 5px;
    }
    
    @keyframes latido {
      0% { transform: scale(0.9); opacity: 0.7; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(0.9); opacity: 0.7; }
    }
    
    .lluvia-valor {
      font-size: 28px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }
    
    .cauce-alto .lluvia-valor {
      color: var(--color-cauce-alto);
    }
    
    .cauce-medio .lluvia-valor {
      color: var(--color-cauce-medio);
    }
    
    .cauce-bajo .lluvia-valor {
      color: var(--color-cauce-bajo);
    }
    
    .actualizacion {
      font-size: 11px;
      text-align: right;
      color: var(--texto-secundario);
    }
    
    .promedio-total {
      background-color: var(--fondo-tarjeta);
      border-radius: 8px;
      padding: 12px;
      margin-top: 5px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .promedio-total .lluvia-valor {
      color: var(--color-promedio);
      font-size: 24px;
      margin: 5px 0;
    }
    
    .promedio-titulo {
      font-size: 14px;
      color: var(--texto-secundario);
    }
    
    .info-estaciones {
      font-size: 11px;
      text-align: center;
      color: var(--texto-secundario);
      margin: 15px 0 5px 0;
      padding: 0 10px;
      line-height: 1.4;
    }
    
    .footer {
      text-align: center;
      margin-top: auto;
      padding-top: 5px;
      font-size: 11px;
      color: var(--texto-secundario);
    }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="encabezado">
      <h1><i class="fas fa-water"></i> Arroyo Pinazo-Escobar</h1>
      <h2>Alerta lluvias caÃ­das sobre el cauce</h2>
    </div>
    
    <div class="selector-tiempo">
      <button class="active" data-horas="24">24h</button>
      <button data-horas="48">48h</button>
      <button data-horas="72">72h</button>
    </div>
    
    <div class="grid-cauces">
      <!-- CAUCE ALTO -->
      <div class="tarjeta-cauce cauce-alto">
        <div class="cauce-header">
          <div class="cauce-titulo">
            <i class="fas fa-arrow-up"></i>
            <span>CAUCE ALTO</span>
          </div>
          <div class="estado-activo">
            <div class="temperatura">
              <i class="fas fa-thermometer-half"></i>
              <span id="temp-alto">--Â°C</span>
            </div>
            <div class="latido" title="App activa"></div>
          </div>
        </div>
        <div class="lluvia-valor" id="lluvia-alto">-- mm</div>
        <div class="actualizacion" id="actualizacion-alto">Actualizando...</div>
      </div>
      
      <!-- CAUCE MEDIO -->
      <div class="tarjeta-cauce cauce-medio">
        <div class="cauce-header">
          <div class="cauce-titulo">
            <i class="fas fa-arrows-alt-h"></i>
            <span>CAUCE MEDIO</span>
          </div>
          <div class="estado-activo">
            <div class="temperatura">
              <i class="fas fa-thermometer-half"></i>
              <span id="temp-medio">--Â°C</span>
            </div>
            <div class="latido" title="App activa"></div>
          </div>
        </div>
        <div class="lluvia-valor" id="lluvia-medio">-- mm</div>
        <div class="actualizacion" id="actualizacion-medio">Actualizando...</div>
      </div>
      
      <!-- CAUCE BAJO -->
      <div class="tarjeta-cauce cauce-bajo">
        <div class="cauce-header">
          <div class="cauce-titulo">
            <i class="fas fa-arrow-down"></i>
            <span>CAUCE BAJO</span>
          </div>
          <div class="estado-activo">
            <div class="temperatura">
              <i class="fas fa-thermometer-half"></i>
              <span id="temp-bajo">--Â°C</span>
            </div>
            <div class="latido" title="App activa"></div>
          </div>
        </div>
        <div class="lluvia-valor" id="lluvia-bajo">-- mm</div>
        <div class="actualizacion" id="actualizacion-bajo">Actualizando...</div>
      </div>
      
      <!-- PROMEDIO TOTAL -->
      <div class="promedio-total">
        <div class="promedio-titulo">Agua caÃ­da sobre el cauce total</div>
        <div class="lluvia-valor" id="lluvia-total">-- mm</div>
        <div class="actualizacion" id="actualizacion-total">Actualizando...</div>
      </div>
    </div>
    
    <div class="info-estaciones">
      Estaciones meteo: La Lonja (PILAR), Boeros (DEL VISO), Acacias Blancas y Palmer's (Ruta 26), 
      Barrios Santa Isabel y Puertos (Escobar desembocadura)
    </div>
    
    <div class="footer">Creado por guardianesarroyosba Â© ðŸ‡¦ðŸ‡· | Actualizado: <span id="update-time">--:--</span></div>
  </div>

  <script>
    // ConfiguraciÃ³n de estaciones
    const estaciones = {
      pilar: {
        id: "IPILAR8",
        segmento: "alto"
      },
      delviso: {
        id: "IDELVI2",
        segmento: "alto"
      },
      acacias: {
        id: "IBELND11",
        segmento: "medio"
      },
      maschwitzRuta: {
        id: "IINGEN19",
        segmento: "medio"
      },
      maschwitzSI: {
        id: "IINGEN39",
        segmento: "bajo"
      },
      muelles: {
        id: "IBELND33",
        segmento: "bajo"
      }
    };
    
    const apiKey = "6532d6454b8aa370768e63d6ba5a832e";
    const intervaloActualizacion = 10 * 60 * 1000; // 10 minutos
    let horasSeleccionadas = 24;
    let ultimosDatos = {};
    
    // FunciÃ³n para obtener lluvia acumulada
    async function obtenerLluviaAcumulada(idEstacion, horas) {
      try {
        const fechaFin = new Date();
        const fechaInicio = new Date(fechaFin);
        fechaInicio.setHours(fechaInicio.getHours() - horas);
        
        const url = `https://api.weather.com/v2/pws/history/hourly?stationId=${idEstacion}&format=json&units=m&apiKey=${apiKey}&startDate=${fechaInicio.toISOString().split('T')[0]}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.observations?.length > 0) {
          const lluviaTotal = data.observations.reduce((total, obs) => {
            return total + (obs.metric.precipTotal || 0);
          }, 0);
          
          return {
            valor: lluviaTotal.toFixed(1),
            actualizacion: data.observations[0].obsTimeLocal
          };
        }
      } catch (error) {
        console.error(`Error obteniendo datos de ${idEstacion}:`, error);
      }
      
      return {
        valor: "--",
        actualizacion: "Error"
      };
    }
    
    async function obtenerDatosActuales(idEstacion) {
      try {
        const response = await fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${idEstacion}&format=json&units=m&apiKey=${apiKey}`);
        const data = await response.json();
        return data.observations[0];
      } catch (error) {
        console.error(`Error obteniendo datos actuales de ${idEstacion}:`, error);
        return null;
      }
    }
    
    function calcularPromedios() {
      const segmentos = {
        alto: { lluvia: [], temp: [] },
        medio: { lluvia: [], temp: [] },
        bajo: { lluvia: [], temp: [] },
        total: { lluvia: [], temp: [] }
      };
      
      // Agrupar datos por segmento
      for (const [key, estacion] of Object.entries(estaciones)) {
        if (ultimosDatos[key] && ultimosDatos[key].lluvia !== "--") {
          segmentos[estacion.segmento].lluvia.push(parseFloat(ultimosDatos[key].lluvia));
          segmentos.total.lluvia.push(parseFloat(ultimosDatos[key].lluvia));
        }
        if (ultimosDatos[key] && ultimosDatos[key].temp !== "--") {
          segmentos[estacion.segmento].temp.push(parseFloat(ultimosDatos[key].temp));
          segmentos.total.temp.push(parseFloat(ultimosDatos[key].temp));
        }
      }
      
      // Calcular promedios
      const promedios = {
        lluvia: {
          alto: segmentos.alto.lluvia.length > 0 ? (segmentos.alto.lluvia.reduce((a, b) => a + b, 0) / segmentos.alto.lluvia.length).toFixed(1) : "--",
          medio: segmentos.medio.lluvia.length > 0 ? (segmentos.medio.lluvia.reduce((a, b) => a + b, 0) / segmentos.medio.lluvia.length).toFixed(1) : "--",
          bajo: segmentos.bajo.lluvia.length > 0 ? (segmentos.bajo.lluvia.reduce((a, b) => a + b, 0) / segmentos.bajo.lluvia.length).toFixed(1) : "--",
          total: segmentos.total.lluvia.length > 0 ? (segmentos.total.lluvia.reduce((a, b) => a + b, 0) / segmentos.total.lluvia.length).toFixed(1) : "--"
        },
        temp: {
          alto: segmentos.alto.temp.length > 0 ? (segmentos.alto.temp.reduce((a, b) => a + b, 0) / segmentos.alto.temp.length).toFixed(1) : "--",
          medio: segmentos.medio.temp.length > 0 ? (segmentos.medio.temp.reduce((a, b) => a + b, 0) / segmentos.medio.temp.length).toFixed(1) : "--",
          bajo: segmentos.bajo.temp.length > 0 ? (segmentos.bajo.temp.reduce((a, b) => a + b, 0) / segmentos.bajo.temp.length).toFixed(1) : "--"
        }
      };
      
      return promedios;
    }
    
    async function actualizarDatos() {
      const actualizaciones = [];
      ultimosDatos = {};
      
      for (const [key, estacion] of Object.entries(estaciones)) {
        // Obtener datos actuales (temperatura)
        const datosActuales = await obtenerDatosActuales(estacion.id);
        const temp = datosActuales?.metric.temp ?? "--";
        
        // Obtener lluvia acumulada
        const lluvia = await obtenerLluviaAcumulada(estacion.id, horasSeleccionadas);
        
        ultimosDatos[key] = {
          lluvia: lluvia.valor,
          temp: temp,
          actualizacion: lluvia.actualizacion
        };
        actualizaciones.push(new Date(lluvia.actualizacion));
      }
      
      // Calcular y actualizar promedios
      const promedios = calcularPromedios();
      
      // Actualizar lluvia
      document.getElementById('lluvia-alto').textContent = `${promedios.lluvia.alto} mm`;
      document.getElementById('lluvia-medio').textContent = `${promedios.lluvia.medio} mm`;
      document.getElementById('lluvia-bajo').textContent = `${promedios.lluvia.bajo} mm`;
      document.getElementById('lluvia-total').textContent = `${promedios.lluvia.total} mm`;
      
      // Actualizar temperatura
      document.getElementById('temp-alto').textContent = `${promedios.temp.alto}Â°C`;
      document.getElementById('temp-medio').textContent = `${promedios.temp.medio}Â°C`;
      document.getElementById('temp-bajo').textContent = `${promedios.temp.bajo}Â°C`;
      
      // Actualizar hora de actualizaciÃ³n
      const ultimaActualizacion = new Date(Math.max(...actualizaciones.filter(d => d instanceof Date)));
      const horaActualizacion = ultimaActualizacion.toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});
      
      document.getElementById('actualizacion-alto').textContent = `Actualizado: ${horaActualizacion}`;
      document.getElementById('actualizacion-medio').textContent = `Actualizado: ${horaActualizacion}`;
      document.getElementById('actualizacion-bajo').textContent = `Actualizado: ${horaActualizacion}`;
      document.getElementById('actualizacion-total').textContent = `Actualizado: ${horaActualizacion}`;
      
      // Actualizar pie de pÃ¡gina
      document.getElementById('update-time').textContent = 
        new Date().toLocaleTimeString('es-AR', {hour: '2-digit', minute:'2-digit'});
    }
    
    // Selector de tiempo
    document.querySelectorAll('.selector-tiempo button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelector('.selector-tiempo button.active').classList.remove('active');
        button.classList.add('active');
        horasSeleccionadas = parseInt(button.dataset.horas);
        actualizarDatos();
      });
    });
    
    // InicializaciÃ³n
    actualizarDatos();
    setInterval(actualizarDatos, intervaloActualizacion);
  </script>
</body>
</html>